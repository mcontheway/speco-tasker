# 阶段0：大纲与研究

## 研究任务执行结果

### 1. 路径配置系统最佳实践研究

**决策：采用配置文件 + 常量映射的混合方案**
**理由：**
- 提供运行时灵活性，同时保持代码可维护性
- 支持跨平台路径处理
- 便于版本控制和部署

**考虑过的替代方案：**
- 纯环境变量：缺乏结构化和类型安全
- 数据库配置：增加复杂度和依赖
- 硬编码路径：缺乏灵活性

**技术实现：**
```javascript
// 配置文件结构
{
  "paths": {
    "root": ".speco",
    "dirs": {
      "tasks": "tasks",
      "docs": "docs"
    },
    "files": {
      "tasks": "tasks.json",
      "config": "config.json"
    }
  }
}
```

### 2. 大规模AI代码清理策略研究

**决策：采用渐进式清理 + 验证机制**
**理由：**
- 确保清理完整性，避免遗漏
- 保护核心功能不受影响
- 支持回滚和验证

**清理策略：**
1. **识别阶段**：建立AI内容清单（已确认187个文件）
2. **分类清理**：
   - AI服务调用：移除anthropic/openai等导入
   - 条件分支：清理AI功能相关的if/else
   - 配置文件：移除AI相关的配置项
   - 文档：清理AI功能说明
3. **验证机制**：
   - 语法检查：确保清理后代码可编译
   - 功能测试：验证核心功能正常
   - 回归测试：防止意外删除重要功能

**风险控制：**
- 备份原始文件
- 分批次清理
- 每次清理后运行测试

### 3. 文件重命名原子性保障机制研究

**决策：采用事务性重命名 + 回滚机制**
**理由：**
- 确保重命名的原子性
- 提供失败回滚能力
- 避免服务中断

**实现机制：**
```javascript
// 原子性重命名流程
async function atomicRename(oldPath, newPath) {
  const tempPath = `${oldPath}.tmp`;
  const backupPath = `${oldPath}.backup`;

  try {
    // 1. 创建临时文件
    await fs.copyFile(oldPath, tempPath);

    // 2. 创建备份
    await fs.copyFile(oldPath, backupPath);

    // 3. 更新package.json（原子操作）
    await updatePackageJsonBin(oldPath, newPath);

    // 4. 重命名文件
    await fs.rename(tempPath, newPath);

    // 5. 清理备份
    await fs.unlink(backupPath);

  } catch (error) {
    // 回滚操作
    if (fs.existsSync(tempPath)) await fs.unlink(tempPath);
    if (fs.existsSync(backupPath)) {
      await fs.rename(backupPath, oldPath);
    }
    throw error;
  }
}
```

### 4. 跨平台兼容性研究

**决策：使用Node.js path模块 + 规范化处理**
**理由：**
- Node.js path模块已处理平台差异
- 提供统一的路径操作API
- 自动处理分隔符转换

**关键点：**
- 使用`path.join()`替代字符串拼接
- 使用`path.resolve()`获取绝对路径
- 配置文件中的路径统一使用正斜杠

### 5. 配置系统性能影响研究

**决策：采用缓存 + 懒加载机制**
**理由：**
- 平衡性能和灵活性
- 避免每次访问都读取文件
- 支持配置热重载

**性能优化：**
- 配置文件缓存到内存
- 文件变更时自动失效缓存
- 支持配置监听和自动重载

## 技术风险评估

### 高风险项
1. **AI清理不完整**：可能导致功能异常或安全问题
2. **文件重命名失败**：可能导致服务不可用
3. **配置兼容性**：新旧配置格式转换问题

### 中风险项
1. **路径解析错误**：跨平台路径处理问题
2. **权限不足**：文件操作权限问题
3. **并发访问**：多进程同时访问配置文件

### 低风险项
1. **内存占用**：配置文件缓存影响
2. **启动时间**：配置加载时间影响

## 解决方案设计

### 1. AI清理安全保障
- **前置条件**：建立完整的AI内容清单
- **清理顺序**：从外围依赖到核心功能
- **验证机制**：每次清理后运行核心功能测试
- **回滚准备**：保留原始文件备份

### 2. 文件重命名安全保障
- **原子操作**：使用临时文件 + 事务机制
- **状态检查**：重命名前检查文件状态
- **权限验证**：确保有足够的文件操作权限
- **服务连续性**：确保重命名过程中服务可用

### 3. 配置系统稳定性保障
- **默认配置**：提供完整的默认配置
- **配置验证**：启动时验证配置完整性
- **错误恢复**：配置错误时自动回滚到默认配置
- **迁移工具**：提供配置格式迁移工具

## 实施建议

### 优先级排序
1. **第一优先级**：建立路径配置系统（FR-001）
2. **第二优先级**：实现文件重命名时序机制（FR-012）
3. **第三优先级**：清理package.json冲突（FR-010）
4. **第四优先级**：AI内容清理（FR-011）

### 分阶段验证
- **阶段1验证**：路径配置系统功能正常
- **阶段2验证**：文件重命名安全可靠
- **阶段3验证**：package.json配置正确
- **阶段4验证**：AI清理完整且功能正常

所有NEEDS CLARIFICATION问题已解决，研究阶段完成。
