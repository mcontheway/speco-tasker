# 研究报告：MCP 接口 spec_files 字段完整实现

**功能分支**: 003-feature-mcp-spec-files-description
**日期**: 2025年09月23日
**研究目标**: 分析 MCP 协议参数验证模式，JSON Schema 设计模式，API 版本控制策略

## 研究问题

### 1. MCP 协议参数验证模式

**现状分析**:
- MCP 协议使用 JSON-RPC 2.0 作为通信基础
- 工具参数通过 JSON Schema 进行验证
- 当前实现使用 Zod 作为 TypeScript 运行时验证库

**最佳实践**:
- 使用 Zod 的 `z.object()` 定义复杂对象结构
- 使用 `z.array()` 定义数组参数
- 使用 `z.enum()` 定义枚举值约束
- 使用 `.describe()` 提供参数文档

**决策**: 使用 Zod 对象数组定义 spec_files 参数，提供完整的类型安全和验证

### 2. JSON Schema 设计模式

**复杂对象数组设计**:
```typescript
// 当前：字符串格式
spec_files: z.string().describe("用逗号分隔的文件路径")

// 目标：对象数组格式
spec_files: z.array(
  z.object({
    type: z.enum(["plan", "spec", "requirement", "design", "test", "other"]),
    title: z.string(),
    file: z.string()
  })
)
```

**验证策略**:
- 数组最小长度验证（主任务必需）
- 对象字段存在性验证
- 枚举值约束验证
- 字符串非空验证

**决策**: 采用完整的对象数组模式，提供结构化和类型安全的数据模型

### 3. API 版本控制策略

**兼容性分析**:
- MCP 工具是向后兼容的（breaking change 需要新工具名称）
- 当前无向后兼容性需求（产品未发布）
- 可以直接采用新格式

**版本策略**:
- 工具名称保持不变
- 参数格式完全重构
- 错误消息增强，提供清晰的格式指导

**决策**: 直接采用新参数格式，无需兼容性层

## 技术实现分析

### MCP 工具架构

**当前架构**:
```
MCP 工具注册 → Zod 参数验证 → Direct 函数调用 → 核心业务逻辑
```

**修改点**:
1. **工具参数定义**: 更新 Zod schema
2. **Direct 函数**: 处理对象数组参数
3. **核心逻辑**: 无需修改（已支持对象数组）

### 错误处理模式

**验证错误**:
- Zod 自动生成详细错误信息
- 需要转换为用户友好的中文错误消息
- 提供格式示例和修复建议

**示例错误处理**:
```typescript
// 参数验证失败
if (!validationResult.success) {
  return createErrorResponse(
    `参数格式错误: ${validationResult.error.message}`,
    "请提供正确的 spec_files 格式，例如: " +
    '[{"type": "spec", "title": "API 文档", "file": "docs/api.md"}]'
  );
}
```

## 风险评估

### 技术风险

1. **参数格式变更**: 中等风险 - MCP 客户端需要更新调用方式
2. **验证逻辑复杂性**: 低风险 - 使用成熟的 Zod 库
3. **性能影响**: 低风险 - JSON 解析开销很小

### 业务风险

1. **用户适应**: 中等风险 - 需要更新使用文档和示例
2. **集成影响**: 低风险 - 只影响 MCP 接口，CLI 保持不变

## 实施建议

### 优先级排序

1. **参数定义更新** (高优先级)
   - 更新所有相关 MCP 工具的 Zod schema
   - 确保枚举值和验证规则一致

2. **错误处理增强** (高优先级)
   - 实现清晰的验证错误消息
   - 提供格式示例和修复建议

3. **Direct 函数适配** (中优先级)
   - 移除字符串处理逻辑
   - 直接传递对象数组

4. **文档更新** (中优先级)
   - 更新 MCP 工具使用文档
   - 提供完整的示例

### 测试策略

1. **单元测试**: 参数验证逻辑
2. **集成测试**: MCP 工具调用完整流程
3. **端到端测试**: 实际任务创建和更新

## 结论

**核心发现**:
- MCP 协议支持复杂对象数组参数
- Zod 提供了完整的验证能力
- 无需向后兼容性考虑

**实施路径**:
1. 直接采用对象数组格式
2. 增强错误处理和用户体验
3. 保持与其他接口的一致性

**预期收益**:
- 提升 MCP 接口的功能完整性
- 改善开发人员体验
- 建立规范的规范文档管理流程
