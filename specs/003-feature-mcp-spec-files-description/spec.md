# 功能规格：修复 MCP 接口中 spec_files 字段的完整实现

**功能分支** : `003-feature-mcp-spec-files-description`
**创建时间** : 2025年09月23日
**状态** : 草稿
**输入** : 用户描述: "修复 MCP 接口中 spec_files 字段的完整实现"

## 执行流程（主流程）

```
1. 从输入中解析用户描述
   → 识别 spec_files 字段实现问题
2. 分析当前 MCP 接口限制
   → MCP 工具只接受字符串格式，无法创建完整对象数组
3. 识别需要修改的文件
   → MCP 工具定义、Direct 函数、参数验证逻辑
4. 设计向后兼容的解决方案
   → 支持 JSON 对象数组，同时保持字符串格式兼容
5. 实现修改
   → 更新工具参数 schema、处理逻辑、验证逻辑
6. 测试修改
   → 验证新旧格式都能正常工作
7. 返回：成功（MCP 接口 spec_files 功能已完善）
```

* * *

## ⚡ 快速指南

*   ✅ 关注用户需要什么以及为什么
*   ❌ 避免实现方式（不涉及技术栈、API、代码结构）
*   👥 面向商业利益相关者，而非开发者

### 章节要求

*   **必填章节** ：每个功能都必须完成
*   **可选章节** ：仅在相关时包含
*   当一个部分不适用时，请完全删除它（不要保留为“不适用”）

### 用于 AI 生成

当从用户提示创建此规范时：

1.  **标记所有模糊之处** ：对于任何需要做出的假设，请使用\[需要澄清：具体问题\]
2.  **不要猜测** ：如果提示没有明确说明某些内容（例如，没有认证方法的"登录系统"），应将其标记
3.  **像测试人员一样思考** ：每个模糊的需求都应通过"可测试性和无歧义性"检查清单项目
4.  **常见的未明确说明的领域** ：
    *   用户类型和权限
    *   数据保留/删除政策
    *   性能目标与规模
    *   错误处理行为
    *   集成要求
    *   安全/合规需求

* * *

## 用户场景与测试 *(强制)*

### 主要用户故事

**作为一名使用 MCP 接口的开发人员**

我希望在创建任务时能够为任务关联完整的规范文档信息，包括文档类型（如"plan"、"spec"、"requirement"）和自定义标题，而不仅仅是简单的文件名。

**具体来说：**
- 当我创建新任务时，我想要能够指定多个规范文档，每个文档都有明确的类型（计划文档、规格文档、需求文档等）
- 我希望能够为每个文档提供有意义的标题，而不是仅仅使用文件名
- 我想要在创建子任务时也能关联相关的规范文档
- 我希望能够更新现有任务的规范文档结构，包括修改类型、标题和文件路径

**这将帮助我：**
- 更好地组织和管理项目的规范文档
- 为任务提供更清晰的上下文信息
- 提高团队协作效率，因为其他人可以快速理解每个文档的用途和内容
- 建立更规范的开发流程，从规范文档到具体实现的完整追踪

### 验收场景

#### 任务创建场景
1.  **给定** 开发人员调用 `add_task` MCP 工具并提供完整的 spec_files JSON 数组：
    ```json
    [{"type": "plan", "title": "Implementation Plan", "file": "docs/plan.md"},
     {"type": "spec", "title": "Technical Specification", "file": "docs/tech-spec.yaml"}]
    ```
    **当** 执行创建操作， **则** 系统成功创建任务，并正确存储完整的规范文档结构

2.  **给定** 开发人员调用 `add_subtask` MCP 工具并提供 spec_files 参数， **当** 执行创建操作， **则** 系统成功创建子任务并关联规范文档

#### 任务更新场景
3.  **给定** 现有任务已创建， **当** 开发人员调用 `update_task` 并提供新的 spec_files JSON 数组， **则** 系统正确更新任务的规范文档结构

4.  **给定** 现有子任务已创建， **当** 开发人员调用 `update_subtask` 并提供 spec_files 参数， **则** 系统正确更新子任务的规范文档

#### 验证和错误处理场景
5.  **给定** 提供的 spec_files JSON 缺少必要字段（如缺少 `type`）， **当** 执行操作， **则** 系统返回明确的错误信息指出缺少的字段

6.  **给定** 提供的文档类型不在有效列表中， **当** 执行操作， **则** 系统返回错误信息并提供有效的文档类型选项

7.  **给定** 主任务的 spec_files 为空数组， **当** 执行创建操作， **则** 系统返回错误要求至少提供一个规范文档

### 边界情况

*   当提供无效的 JSON 格式 spec_files 时会发生什么？
*   系统如何处理空的 spec_files 数组？
*   当 spec_files 对象缺少必要字段时会发生什么？

## 需求 *(必须)*

### 功能需求

#### 参数格式要求
*   **FR-001**: `add_task` MCP 工具的 spec_files 参数必须支持 JSON 对象数组格式，每个对象包含 `type`、`title`、`file` 字段
*   **FR-002**: `update_task` MCP 工具的 spec_files 参数必须支持 JSON 对象数组格式，用于更新任务的规范文档
*   **FR-003**: `add_subtask` MCP 工具必须新增 spec_files 参数，支持 JSON 对象数组格式
*   **FR-004**: `update_subtask` MCP 工具的 spec_files 参数必须支持 JSON 对象数组格式

#### 数据验证要求
*   **FR-005**: 系统必须验证 JSON 对象数组中的每个元素都包含必需的字段：
  - `type`: 字符串类型，表示文档类型（如 "plan"、"spec"、"requirement"）
  - `title`: 字符串类型，表示文档标题
  - `file`: 字符串类型，表示文档文件路径
*   **FR-006**: 系统必须验证 spec_files 至少包含一个文档对象（主任务必需，子任务可选）
*   **FR-007**: 系统必须验证文档类型为预定义的有效值

#### 错误处理要求
*   **FR-008**: 当提供无效的 JSON 格式时，系统必须返回清晰的错误信息，指示期望的格式
*   **FR-009**: 当 spec_files 对象缺少必要字段时，系统必须指出具体缺少哪些字段
*   **FR-010**: 当文档类型无效时，系统必须提供有效的文档类型列表

#### 功能完整性要求
*   **FR-011**: Direct 函数必须正确处理 JSON 对象数组格式，传递给核心任务管理逻辑
*   **FR-012**: 系统必须支持创建、更新、读取操作中的完整 spec_files 结构
*   **FR-013**: 子任务的 spec_files 字段必须独立于父任务，不自动继承

### 关键实体 *(如果功能涉及数据，请包含)*

*   **规范文档对象**: 表示单个规范文档，包含类型（type）、标题（title）和文件路径（file）
*   **MCP 工具参数**: 定义工具接受的参数格式和验证规则
*   **任务数据结构**: 包含 spec_files 字段的任务和子任务对象

* * *

## 评审与验收清单

*GATE：在 main()执行期间运行自动检查*

### 内容质量

- [ ] 不涉及具体实现细节（语言、框架、API）
- [ ] 专注于用户价值和业务需求
- [ ] 为非技术利益相关者编写
- [ ] 所有必填部分已完成

### 需求完整性

- [ ] 没有[需要澄清]标记剩余
- [ ] 需求是可测试且无歧义的
- [ ] 成功标准是可衡量的
- [ ] 范围明确界定
- [ ] 识别了依赖关系和假设

* * *

## 执行状态

*在处理过程中由 main() 更新*

- [ ] 用户描述已解析
- [ ] 关键概念已提取
- [ ] 标记的歧义
- [ ] 定义的用户场景
- [ ] 生成的需求
- [ ] 识别的实体
- [ ] 审查清单已通过

* * *
