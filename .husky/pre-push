#!/usr/bin/env sh

# è¿è¡Œæ¨é€å‰æµ‹è¯•ï¼ˆå¿«é€ŸéªŒè¯ï¼Œé¿å…ä¸pre-commité‡å ï¼‰
echo "ğŸ§ª æ­£åœ¨è¿è¡Œæ¨é€å‰éªŒè¯..."

# è¿è¡Œæ ¸å¿ƒå•å…ƒæµ‹è¯•çš„å­é›†ï¼ˆå¿«é€Ÿæ£€æŸ¥ï¼‰
echo "  ğŸ“¦ è¿è¡Œæ ¸å¿ƒå•å…ƒæµ‹è¯•éªŒè¯..."
npm run test:unit -- --passWithNoTests --silent --verbose=false || {
  echo "âš ï¸  å•å…ƒæµ‹è¯•å¤±è´¥ï¼Œä½†å…è®¸æ¨é€ï¼ˆå»ºè®®ä¿®å¤ï¼‰"
}

# è¿è¡Œå…³é”®é›†æˆæµ‹è¯•ï¼ˆå¿«é€ŸéªŒè¯æ ¸å¿ƒåŠŸèƒ½ï¼‰
echo "  ğŸ”— è¿è¡Œå…³é”®é›†æˆæµ‹è¯•..."
npm run test:integration -- --passWithNoTests --silent --verbose=false --testNamePattern="should add dependency|should create and manage basic tags" || {
  echo "âš ï¸  å…³é”®é›†æˆæµ‹è¯•å¤±è´¥ï¼Œä½†å…è®¸æ¨é€ï¼ˆå»ºè®®ä¿®å¤ï¼‰"
}

# è¿è¡Œå¿«é€ŸE2EéªŒè¯ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
echo "  ğŸš€ è¿è¡Œå¿«é€ŸE2EéªŒè¯..."
if [ -f "tests/e2e/run_e2e.sh" ]; then
  timeout 60s bash tests/e2e/run_e2e.sh --quick-verify 2>/dev/null || {
    echo "âš ï¸  E2EéªŒè¯è¶…æ—¶æˆ–å¤±è´¥ï¼Œä½†å…è®¸æ¨é€"
  }
else
  echo "    â„¹ï¸  E2Eæµ‹è¯•è„šæœ¬ä¸å­˜åœ¨ï¼Œè·³è¿‡"
fi

# æ£€æŸ¥æ˜¯å¦æœ‰æœªå¤„ç†çš„ changesetï¼ˆä»…è­¦å‘Šï¼Œä¸é˜»æ­¢æ¨é€ï¼‰
if [ -d ".changeset" ] && [ "$(ls -A .changeset/*.md 2>/dev/null)" ]; then
  echo "âš ï¸  æ£€æµ‹åˆ°æœªå¤„ç†çš„ changeset æ–‡ä»¶"
  echo "   ğŸ’¡ æç¤ºï¼šå½“å‡†å¤‡å‘å¸ƒæ—¶ï¼Œè¿è¡Œ 'npm run release' æ¥å¤„ç†è¿™äº›å˜æ›´"
  echo "   ğŸ“ å¦‚æœéœ€è¦æ·»åŠ æ›´å¤šå˜æ›´è¯´æ˜ï¼Œè¿è¡Œ 'npm run changeset'"
  echo ""
fi

# æ£€æŸ¥æäº¤æ¶ˆæ¯è´¨é‡ï¼ˆæœ€è¿‘5ä¸ªæäº¤ï¼‰
echo "  ğŸ“ æ£€æŸ¥æœ€è¿‘æäº¤è´¨é‡..."
if command -v git >/dev/null 2>&1; then
  recent_commits=$(git log --oneline -5 2>/dev/null | head -3)
  if [ -n "$recent_commits" ]; then
    echo "    æœ€è¿‘æäº¤ï¼š"
    echo "$recent_commits" | sed 's/^/      /'
  fi
fi

echo "âœ… æ¨é€å‰éªŒè¯å®Œæˆï¼Œå¯ä»¥æ¨é€"
